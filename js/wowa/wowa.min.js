"use strict";var skeleton,modelLoader,targetX,mikuMesh,light,clip1,action1,clip2,action2,clock,mixer,helper,inRange,damp,prePointer,pointDown,cameraGroup,deltaMoveX,deltaMoveY,lastDeltaMoveX,lastDeltaMoveY,deltaMoveValueX,deltaMoveValueY,curPointer,pointerPos,tempImage,imageContext,innerGroup,delayTapToStart,audioFinished,isPointerdown,lastPointers,pointers,minScale,layerName,maxScale,guideX,guideY,mouseX,mouseY,canvasList,curScale,tempCanvas,tempContext,dataUrl,pointerMaxSize,lastDrawData,canvasCtx,guide,penSize,penPercent,eraserPercent,picker,penColor,eraserSize,pointerRadius,percent,sliderWidth,curLayer,sliderBorder,undoList,redoList,curTool,Tools,audioFadeOutTimer,isDrawActive,audioStatus,gainNode,sourceNode,audioCtx,audioBuffer,gameStart,canvasjq,initTween,isAboutActive,isMobile,scene,camera,renderer,canvasRoot,group,box,gui;function initGUI(){}function stopEvent(e){(e=e||window.event).preventDefault?(e.preventDefault(),e.stopPropagation()):(e.returnValue=!1,e.cancelBubble=!0)}function stopPropagation(e){(e=e||window.event).stopPropagation()}function preventDefault(e){(e=e||window.event).preventDefault?e.preventDefault():e.returnValue=!1}async function initScene(){scene=new THREE.Scene,group=new THREE.Group,cameraGroup=new THREE.Group,scene.add(group),scene.add(cameraGroup),group.position.set(0,0,0),cameraGroup.position.set(0,0,0),cameraGroup.add(camera),innerGroup=new THREE.Group,group.add(innerGroup),innerGroup.position.set(0,0,0),innerGroup.rotation.set(0,0,0),modelLoader=new THREE.MMDLoader;let load=()=>new Promise((resolve,reject)=>modelLoader.load("model/paper_miku.pmd",object=>resolve(object),null,error=>reject(object)));mikuMesh=await load(),skeleton=mikuMesh.skeleton,initGUI();let loadMotion=(motionPath,mesh)=>new Promise((resolve,reject)=>modelLoader.loadAnimation(motionPath,mesh,animClip=>resolve(animClip),null,error=>reject(animClip)));clip1=await loadMotion("model/motion.vmd",mikuMesh),clip2=await loadMotion("model/motion2.vmd",mikuMesh);let mat=mikuMesh.material[0];mat.side=THREE.DoubleSide,mat.transparent=!0,innerGroup.add(mikuMesh),mikuMesh.position.set(0,-7,0),mikuMesh.scale.set(1.7,1.7,1),mikuMesh.rotation.y=Math.PI,(helper=new THREE.MMDAnimationHelper).add(mikuMesh,{animation:clip1,physics:!0}),mixer=helper.objects.get(mikuMesh).mixer,action1=mixer.clipAction(clip1),action2=mixer.clipAction(clip2),action1.play();var geometry=new THREE.BoxGeometry(5,500,5);let mats=[];for(let i=0;i<geometry.groups.length;i++){let m=new THREE.MeshLambertMaterial({color:2==i?8224125:4144959});m.side=THREE.DoubleSide,mats.push(m)}box=new THREE.Mesh(geometry,mats),innerGroup.add(box),box.position.set(0,-257,0);var offsetY=8,offsetZ=-16;initTween=new TWEEN.Tween(0).to(1,900).onUpdate(v=>group.position.set(0,8-8*v,-16- -16*v)).onComplete(()=>{initTween.stop(),initTween=null,group.position.set(0,0,0)}).onStart(()=>{gsap.fromTo(group.rotation,{x:-.3},{duration:3,x:.2,repeat:-1,ease:"power1.inOut",yoyo:!0}),gsap.fromTo(group.rotation,{y:-.15},{duration:4,y:.15,repeat:-1,ease:"power1.inOut",yoyo:!0})}).easing(TWEEN.Easing.Quadratic.InOut).start()}function initCamera(){(camera=new THREE.PerspectiveCamera(60,window.innerWidth/window.innerHeight,1,1e4)).position.set(0,0,-12.5),camera.lookAt(new THREE.Vector3(0,0,-1))}function initRenderer(){(renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0,canvas:document.querySelector("#canvas"),precision:"highp"})).setSize(window.innerWidth,window.innerHeight),renderer.setClearColor(16777215,1),renderer.setPixelRatio(window.devicePixelRatio)}function initLight(){light=new THREE.AmbientLight(14540253,1),scene.add(light)}function initData(){undoList=[],redoList=[],pointers=[],lastPointers=[],Tools={Pen:0,Eraser:1},curLayer=curScale=1,sliderBorder=5,penPercent=eraserPercent=.25,penSize=eraserSize=.25*(pointerMaxSize=40),penColor={r:0,g:0,b:0},inRange=isDrawActive=isAboutActive=gameStart=isPointerdown=delayTapToStart=audioFinished=!1,$("#about").css({display:"none",opacity:"0"}),$("#about_bg").css({display:"none",opacity:"0"}),isMobile=Utils.isMobile(navigator.userAgent),$("#tips").html((isMobile?"TAP":"CLICK")+" TO START"),(canvasRoot=$("#canvas_root")).css("opacity",".35"),canvasjq=$("#canvas"),pointerRadius=.5*$("#pointer").width(),sliderWidth=$("#slider").width(),guide=$("#guide"),(canvasCtx=[])[1]=$("#above")[0].getContext("2d"),canvasCtx[2]=$("#under")[0].getContext("2d"),$("#guide canvas").attr({width:1024,height:1024}),(tempCanvas=$("<canvas/>")).attr({width:1024,height:1024}),tempCanvas.css({width:"1024px",height:"1024px"}),tempContext=tempCanvas[0].getContext("2d"),(canvasList=[])[1]=$("#above"),canvasList[2]=$("#under"),minScale=.4,maxScale=4,prePointer=new THREE.Vector2(0,0),curPointer=new THREE.Vector2(0,0),imageContext=new Image,tempImage=new Image,pointerPos=new THREE.Vector2(0,0),deltaMoveValueX=0,pointDown=!1,clock=new THREE.Clock}function rendererUpdate(){updateController(),TWEEN.update(),helper&&helper.update(clock.getDelta()),requestAnimationFrame(rendererUpdate),renderer.render(scene,camera)}function updateController(){null!=group&&(deltaMoveX=.004*(curPointer.x-prePointer.x),(deltaMoveY=.006*(curPointer.y-prePointer.y))&&lastDeltaMoveY-deltaMoveY!=0?deltaMoveValueY=deltaMoveY:deltaMoveValueY>-.001&&deltaMoveValueY<.001?deltaMoveValueY=0:(damp=Math.abs(.08*deltaMoveValueY),Math.abs(deltaMoveValueY)<damp?deltaMoveValueY=0:deltaMoveValueY>0?deltaMoveValueY-=damp:deltaMoveValueY<0&&(deltaMoveValueY+=damp)),deltaMoveValueY&&(inRange=!1,cameraGroup.rotation.x>=.5?deltaMoveValueY<0&&(inRange=!0):cameraGroup.rotation.x<=-.4?deltaMoveValueY>0&&(inRange=!0):inRange=!0,inRange&&(targetX=cameraGroup.rotation.x+deltaMoveValueY,targetX=Utils.clamp(targetX,-.4,.5),cameraGroup.rotation.x=targetX)),deltaMoveX&&lastDeltaMoveX-deltaMoveX!=0?deltaMoveValueX=deltaMoveX:deltaMoveValueX>-.001&&deltaMoveValueX<.001?deltaMoveValueX=0:(damp=Math.abs(.08*deltaMoveValueX),Math.abs(deltaMoveValueX)<damp?deltaMoveValueX=0:deltaMoveValueX>0?deltaMoveValueX-=damp:deltaMoveValueX<0&&(deltaMoveValueX+=damp)),deltaMoveValueX&&innerGroup.rotateY(deltaMoveValueX),lastDeltaMoveX=deltaMoveX,lastDeltaMoveY=deltaMoveY)}function usePen(){curTool!=Tools.Pen&&(curTool=Tools.Pen,$("#pen").css({"background-color":"#c0c0c0","border-radius":"7px"}),$("#eraser").css({"background-color":"transparent"}),$("#slider").animate({left:"0"},200,()=>$("#picker").css("display","block").animate({opacity:"1"},100)),setSliderPointer(penPercent))}function useEraser(){curTool!=Tools.Eraser&&(curTool=Tools.Eraser,$("#eraser").css({"background-color":"#c0c0c0","border-radius":"7px"}),$("#pen").css({"background-color":"transparent"}),$("#slider").animate({left:1.5*$("#pen").width()+"px"},200),$("#picker").css("display","none"),setSliderPointer(eraserPercent))}function updatePaintData(){canvasCtx&&(canvasCtx[curLayer].lineCap="round",canvasCtx[curLayer].lineJoin="round",canvasCtx[curLayer].lineWidth=curTool==Tools.Pen?penSize:eraserSize,canvasCtx[curLayer].globalCompositeOperation=curTool==Tools.Pen?"source-over":"destination-out")}function switchLayer(){curLayer=1==curLayer?2:1,setImage($("#layer img"),"../svg/layer_"+curLayer+".svg")}function setImage(o,url){tempImage.src=url,o.attr("src",tempImage.src)}function initComponent(){$("#bt_about").click(displayAbout),$("#bt_close").click(hideAbout),$("#main").click(tapToStart),$("#info #share #wc").click(()=>shareWebsiteTo("wechat")),$("#info #share #qq").click(()=>shareWebsiteTo("qq")),$("#bt_draw").click(openkipspaint),$("#bt_draw_close").click(closekipspaint),$("#bt_share").click(()=>shareVideo()),$("#draw").css("display","none"),$("#btns").css("display","none"),$("#pen").click(usePen),$("#eraser").click(useEraser),$("#layer").click(switchLayer),$("#clear").click(clearCanvas),$("#undo").click(undo),$("#redo").click(redo),bindEvent($("#slider"),setSlider),(picker=new Colorpicker({isMobile:isMobile,showBg:!0,confirm:color=>{$("#picker").css("background-color","rgb("+color.r+","+color.g+","+color.b+")"),penColor=color,picker.hide()},cancel:()=>picker.hide()})).getRoot().css({"z-index":"10"}),$("#picker").click(e=>{curTool==Tools.Pen&&(stopPropagation(e),picker.setPointerByRGB(penColor.r,penColor.g,penColor.b),picker.show())}),registeModelHandle(),usePen(),$("#use").click(displayCompanion),$("#companion").click(hideCompanion),isMobile&&(setImage($("#use_move"),"../svg/m_mouse_move.svg"),setImage($("#use_zoom"),"../svg/m_mouse_zoom.svg")),saveToUndolist();let minView=window.innerWidth<=window.innerHeight?window.innerWidth:window.innerHeight;guide.css({width:minView+"px",height:minView+"px"}),$("#ok").click(completeDraw),registeDrawHandle()}function getTouchPos(e){var x=0,y=0,length=e.touches.length;for(let i=0;i<length;i++)x+=e.touches[i].pageX,y+=e.touches[i].pageY;return pointerPos.set(x/length,y/length),pointerPos}function updateTouchPos(e){if(pointDown&&gameStart){prePointer.copy(curPointer);var p=getTouchPos(e);curPointer.set(p.x,p.y)}}function stopTouch(e,isDown){pointDown=isDown;var p=getTouchPos(e);prePointer.set(p.x,p.y),curPointer.copy(prePointer)}function stopMouse(e,isDown){prePointer.set(e.pageX,e.pageY),curPointer.copy(prePointer),pointDown=isDown}function updateMousePos(e){pointDown&&gameStart&&(prePointer.copy(curPointer),curPointer.set(e.pageX,e.pageY))}function registeModelHandle(){$(document).oncontextmenu=()=>!1,isMobile?($(document).css("touch-action","auto"),addEvent(document,"touchstart",e=>stopTouch(e,!0),!0),addEvent(document,"touchend",e=>stopTouch(e,!1),!0),addEvent(document,"touchmove",updateTouchPos,!0)):(addEvent(document,"mousedown",e=>stopMouse(e,!0)),addEvent(document,"mouseup",e=>stopMouse(e,!1)),addEvent(document,"mousemove",updateMousePos))}function clearCanvas(){canvasCtx[curLayer].clearRect(0,0,1024,1024),saveToUndolist()}function completeDraw(){tempContext.clearRect(0,0,1024,1024),imageContext.src=canvasList[2][0].toDataURL("image/png"),tempContext.drawImage(imageContext,0,0),imageContext.src=canvasList[1][0].toDataURL("image/png"),tempContext.drawImage(imageContext,0,0);var dataURL=tempCanvas[0].toDataURL("image/png");imageContext.src=dataURL;var texture=(new THREE.TextureLoader).load(dataURL);texture.flipY=!1;var mat=mikuMesh.material[0];mat.map=texture,mat.needsUpdate=!0,closekipspaint()}function displayCompanion(){$("#companion").css({display:"block",opacity:0}).animate({opacity:"1"},200)}function hideCompanion(){$("#companion").animate({opacity:0},200,()=>$("#companion").css({display:"none",opacity:0}))}function handlePointers(e,type){for(let i=0;i<pointers.length;i++)pointers[i].pointerId===e.pointerId&&("update"===type?pointers[i]=e:"delete"===type&&pointers.splice(i,1))}function checkTransparency(){var data1=canvasCtx[1].getImageData(0,0,1024,1024).data,data2=canvasCtx[2].getImageData(0,0,1024,1024).data,isTransparency=!0;for(let i=3;i<data1.length;i+=4)if(0!=data1[i]||0!=data2[i]){isTransparency=!1;break}$("#ok p").css("opacity",isTransparency?".3":"1")}function registeDrawHandle(){$("#draw")[0].oncontextmenu=()=>!1,guide.css("touch-action","none"),$("#draw").css("touch-action","none");let handleMouseEvent,handleTouchEvent=()=>{let save=!1,isDrag=!1,l=parseInt(guide.css("left").replace("px","")),t=parseInt(guide.css("top").replace("px","")),hg=.5*guide.width(),center,waitTimer,startPos=[];addEvent(guide[0],"pointerdown",e=>{save=!1,l=parseInt(guide.css("left").replace("px","")),t=parseInt(guide.css("top").replace("px","")),hg=.5*guide.width(),updatePaintData(),canvasCtx[curLayer].strokeStyle="rgb("+penColor.r+","+penColor.g+","+penColor.b+")",pointers.push(e),lastDrawData={x:pointers[0].clientX-l+hg,y:pointers[0].clientY-t+hg},1==pointers.length?(isPointerdown=!0,waitTimer=setTimeout(()=>{clearTimeout(waitTimer),waitTimer=null},100)):2==pointers.length&&(guideX=locationLeft(guide[0]),guideY=locationTop(guide[0]),center=getCenter({x:pointers[0].clientX,y:pointers[0].clientY},{x:pointers[1].clientX,y:pointers[1].clientY}),mouseX=center.x,mouseY=center.y,isDrag=!0,lastPointers[0]=pointers[0],lastPointers[1]=pointers[1],startPos[0]=pointers[0],startPos[1]=pointers[1])}),addEvent(guide[0],"pointermove",e=>{if("above"==e.target.id){if(isPointerdown)if(handlePointers(e,"update"),1==pointers.length)isDrag||null!=waitTimer||(save=!0,drawCanvas(pointers[0].clientX-l+hg,pointers[0].clientY-t+hg));else if(2==pointers.length){var curDis,lastDis,delta=getDistance(pointers[0].clientX,pointers[0].clientY,pointers[1].clientX,pointers[1].clientY)/getDistance(lastPointers[0].clientX,lastPointers[0].clientY,lastPointers[1].clientX,lastPointers[1].clientY)-1,ratio=delta<0?.99:1.01;const tempScale=ratio*curScale;center=getCenter({x:pointers[0].clientX,y:pointers[0].clientY},{x:pointers[1].clientX,y:pointers[1].clientY}),Math.abs(delta)>.005&&tempScale>minScale&&tempScale<maxScale&&(curScale=tempScale,guide.css({left:center.x-ratio*(center.x-parseFloat(guide.css("left").replace("px","")))+"px",top:center.y-ratio*(center.y-parseFloat(guide.css("top").replace("px","")))+"px",width:guide.width()*ratio+"px",height:guide.width()*ratio+"px"})),moveCanvas(center.x,center.y),lastPointers[0]=pointers[0],lastPointers[1]=pointers[1]}e.preventDefault(!1)}}),addEvent(document,"pointerup",e=>{isPointerdown&&(handlePointers(e,"delete"),save&&saveToUndolist(),0==pointers.length&&(isPointerdown=!1,isDrag&&(isDrag=!1),waitTimer&&(clearTimeout(waitTimer),waitTimer=null)),checkTransparency())}),addEvent(guide[0],"pointercancel",e=>{isPointerdown&&(isPointerdown=!1,pointers.length=0)})};"onmouseup"in document&&(()=>{addEvent(guide[0],"mousedown",e=>{let save=!1,mouseup=()=>{save&&saveToUndolist(),removeEvent(guide[0],"mousemove",mousemove,!1),removeEvent(document,"mouseup",mouseup,!1),checkTransparency()},mousemove=e=>{1==e.which?(save=!0,drawCanvas(e.offsetX,e.offsetY)):2!=e.which&&3!=e.which||moveCanvas(e.clientX,e.clientY)};preventDefault(e),guideX=locationLeft(guide[0]),guideY=locationTop(guide[0]),mouseX=e.clientX,mouseY=e.clientY,lastDrawData={x:e.offsetX,y:e.offsetY},addEvent(guide[0],"mousemove",mousemove,!1),addEvent(document,"mouseup",mouseup,!1),canvasCtx[curLayer].strokeStyle="rgb("+penColor.r+","+penColor.g+","+penColor.b+")",updatePaintData()}),addEvent(guide[0],"mousewheel",scaleCanvas),addEvent(guide[0],"DOMMouseScroll",scaleCanvas)})(),"ontouchend"in document&&handleTouchEvent()}function getDistance(x1,y1,x2,y2){let x=x1-x2,y=y1-y2;return Math.sqrt(x*x+y*y)}function getCenter(a,b){return{x:.5*(a.x+b.x),y:.5*(a.y+b.y)}}function scaleCanvas(e){if("above"!=e.target.id)return;if(e.wheelDelta||e.detail&&(e.wheelDelta=-40*e.detail),0==e.wheelDelta)return;let ratio=e.wheelDelta<0?.9:1.1;var tempScale=ratio*curScale;tempScale>minScale&&tempScale<maxScale&&(curScale=tempScale,guide.css({left:e.clientX-ratio*(e.clientX-parseFloat(guide.css("left").replace("px","")))+"px",top:e.clientY-ratio*(e.clientY-parseFloat(guide.css("top").replace("px","")))+"px",width:guide.width()*ratio+"px",height:guide.width()*ratio+"px"}))}function saveToUndolist(){redoList.length>0&&(redoList=[],setImage($("#redo img"),"../svg/arrow_gray.svg")),dataUrl=$(layerName=1==curLayer?"#above":"#under")[0].toDataURL();var img=new Image;img.src=dataUrl,undoList.push({layer:curLayer,img:img}),undoList.length>1&&(setImage($("#undo img"),"../svg/arrow.svg"),$("#ok p").css("opacity","1"))}function undo(){let d;if(undoList.length>0){if(d=undoList[undoList.length-1],canvasCtx[d.layer].lineWidth=penSize,canvasCtx[d.layer].globalCompositeOperation="source-over",undoList.length>1&&(redoList.push(d),undoList.splice(undoList.length-1,1)),undoList.length>0){let find=!1;for(let i=undoList.length-1;i>0;i--)if(undoList[i].layer==d.layer){canvasCtx[d.layer].clearRect(0,0,1024,1024),canvasCtx[d.layer].drawImage(undoList[i].img,0,0),find=!0;break}find||canvasCtx[d.layer].clearRect(0,0,1024,1024)}undoList.length<=1&&(setImage($("#undo img"),"../svg/arrow_gray.svg"),$("#ok p").css("opacity",".3")),redoList.length>0&&setImage($("#redo img"),"../svg/arrow.svg")}curTool==Tools.Eraser&&null!=d&&(canvasCtx[d.layer].lineWidth=eraserSize,canvasCtx[d.layer].globalCompositeOperation="destination-out"),checkTransparency()}function redo(){let d;redoList.length>0&&(undoList.push(redoList[redoList.length-1]),d=undoList[undoList.length-1],canvasCtx[d.layer].lineWidth=penSize,canvasCtx[d.layer].globalCompositeOperation="source-over",canvasCtx[d.layer].clearRect(0,0,1024,1024),canvasCtx[d.layer].drawImage(d.img,0,0),redoList.splice(redoList.length-1,1)),redoList.length<=0&&setImage($("#redo img"),"../svg/arrow_gray.svg"),undoList.length>1&&(setImage($("#undo img"),"../svg/arrow.svg"),$("#ok p").css("opacity","1")),curTool==Tools.Eraser&&null!=d&&(canvasCtx[d.layer].lineWidth=eraserSize,canvasCtx[d.layer].globalCompositeOperation="destination-out"),checkTransparency()}function addEvent(o,e,f,m){o.attachEvent?o.attachEvent("on"+e,f):m?o.addEventListener(e,f,{passive:!1}):o.addEventListener(e,f,!1)}function removeEvent(o,e,f,m){o.detachEvent?o.detachEvent("on"+e,f):o.removeEventListener(e,f,!!m&&{passive:!1})}function drawCanvas(x,y){null==lastDrawData&&(updatePaintData(),lastDrawData={x:x,y:y}),drawLine(getCanvasValue(lastDrawData.x),getCanvasValue(lastDrawData.y),getCanvasValue(x),getCanvasValue(y)),lastDrawData={x:x,y:y}}function getCanvasValue(v){return v/guide.width()*1024}function drawLine(x1,y1,x2,y2){if(curTool==Tools.Pen)canvasCtx[curLayer].save(),canvasCtx[curLayer].beginPath(),canvasCtx[curLayer].moveTo(x1,y1),canvasCtx[curLayer].lineTo(x2,y2),canvasCtx[curLayer].stroke(),canvasCtx[curLayer].closePath();else{var asin=.5*eraserSize*Math.sin(Math.atan((y2-y1)/(x2-x1))),acos=.5*eraserSize*Math.cos(Math.atan((y2-y1)/(x2-x1))),x3=x1+asin,y3=y1-acos,x4=x1-asin,y4=y1+acos,x5=x2+asin,y5=y2-acos,x6=x2-asin,y6=y2+acos;canvasCtx[curLayer].save(),canvasCtx[curLayer].beginPath(),canvasCtx[curLayer].arc(x2,y2,.5*eraserSize,0,2*Math.PI),canvasCtx[curLayer].clip(),canvasCtx[curLayer].clearRect(0,0,1024,1024),canvasCtx[curLayer].restore(),canvasCtx[curLayer].save(),canvasCtx[curLayer].beginPath(),canvasCtx[curLayer].moveTo(x3,y3),canvasCtx[curLayer].lineTo(x5,y5),canvasCtx[curLayer].lineTo(x6,y6),canvasCtx[curLayer].lineTo(x4,y4),canvasCtx[curLayer].closePath(),canvasCtx[curLayer].clip(),canvasCtx[curLayer].clearRect(0,0,1024,1024),canvasCtx[curLayer].restore()}}function moveCanvas(x,y){guide.css({left:guideX+(x-mouseX)+"px",top:guideY+(y-mouseY)+"px"})}function locationLeft(element){return"BODY"!=element.tagName&&null!=element.offsetParent?element.offsetLeft+locationLeft(element.offsetParent):element.offsetLeft}function locationTop(element){return"BODY"!=element.tagName&&null!=element.offsetParent?element.offsetTop+locationTop(element.offsetParent):element.offsetTop}function openkipspaint(){isDrawActive||(isDrawActive=!0,$("#draw").css({display:"block",top:"0",left:"0"}).animate({opacity:"1"},300,"easeOut"),guide.css({left:.5*window.innerWidth+"px",top:.5*window.innerHeight+"px"}),audiofadeOut())}function closekipspaint(){isDrawActive&&(isDrawActive=!1,$("#draw").animate({opacity:"0"},300,"easeOut",()=>$("#draw").css("display","none")),audioResumefadeIn())}function shareVideo(){}function shareWebsiteTo(app){switch(app){case"wechat":console.log("share wechat");break;case"qq":console.log("share qq")}}function displayAbout(){isAboutActive||(isAboutActive=!0,$("#about_bg").css({display:"block",top:"0",left:"0"}).animate({opacity:"1"},300,"easeOut"),$("#about").css({display:"block",top:"0",left:"0"}).animate({opacity:"1"},300,"easeOut"),gameStart&&audiofadeOut())}function hideAbout(){isAboutActive&&(isAboutActive=!1,$("#about_bg").animate({opacity:"0"},300,"easeOut",()=>$("#about_bg").css("display","none")),$("#about").animate({opacity:"0"},300,"easeOut",()=>$("#about").css("display","none")),gameStart&&audioResumefadeIn())}function tapToStart(){if(!initTween)if(audioFinished){hideAbout(),$("#auth").animate({opacity:"0"},200,"easeOut",()=>$("#auth").css("display","none")),$("#main").animate({opacity:"0"},200,"easeOut",()=>$("#main").css("display","none"));var cameraPos=(new THREE.Vector3).copy(camera.position);action2.crossFadeFrom(action1,.3),action2.play(),helper.enable("animation",!1);var t=new TWEEN.Tween(0).to(1,300).onUpdate(v=>camera.position.set(cameraPos.x,cameraPos.y+2*v,cameraPos.z-9*v)).onComplete(()=>{t.stop(),t=null,gameStart=!0,enterGame()}).onStart(()=>canvasRoot.animate({opacity:1},300,"easeOut")).easing(TWEEN.Easing.Quadratic.Out).start()}else delayTapToStart=!0}function audiofadeIn(){gainNode.gain.value=0,sourceNode.loop=!0,sourceNode.start(0),audioStatus="play",gainNode.gain.linearRampToValueAtTime(.8,audioCtx.currentTime+1)}function enterGame(){canvasRoot.css("opacity",1),$("#btns").css({display:"block",opacity:"0"}).animate({opacity:1},300),audiofadeIn(),$("#audio_load").css({display:"none"})}function audiofadeOut(){gainNode.gain.linearRampToValueAtTime(0,audioCtx.currentTime+.5),audioFadeOutTimer&&clearTimeout(audioFadeOutTimer),audioFadeOutTimer=setTimeout(()=>{audioCtx.suspend(),clearTimeout(audioFadeOutTimer),audioFadeOutTimer=null},500)}function audioResumefadeIn(){audioFadeOutTimer&&clearTimeout(audioFadeOutTimer),gainNode.gain.value=0,audioCtx.resume(),gainNode.gain.linearRampToValueAtTime(.8,audioCtx.currentTime+1)}async function loadAudio(){audioCtx=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext);let response=await fetch("audio/wow.mp3");const reader=response.body.getReader(),contentLength=+response.headers.get("Content-Length");let receivedLength=0,chunks=[];for(;;){const{done:done,value:value}=await reader.read();if(done){$("#audio_load").css({display:"none"});let chunksAll=new Uint8Array(receivedLength),position=0;for(let chunk of chunks)chunksAll.set(chunk,position),position+=chunk.length;audioBuffer=await audioCtx.decodeAudioData(chunksAll.buffer),initAudio(),addEvent(document,"visibilitychange",()=>{"hidden"==document.visibilityState?"play"==audioStatus&&(sourceNode.stop(),audioStatus="stop",gainNode.disconnect(0),sourceNode.disconnect(0)):"visible"==document.visibilityState&&gameStart&&gainNode&&audioCtx&&(initAudio(),audiofadeIn())}),audioFinished=!0,delayTapToStart&&tapToStart();break}chunks.push(value),receivedLength+=value.length,delayTapToStart&&$("#audio_load").animate({width:receivedLength/contentLength*100+"%"},100,()=>$("#audio_load").css({display:"block",width:receivedLength/contentLength*100+"%"}))}}function initAudio(){sourceNode=audioCtx.createBufferSource(),gainNode=audioCtx.createGain(),sourceNode.buffer=audioBuffer,sourceNode.connect(gainNode),gainNode.connect(audioCtx.destination)}function bindEvent(elem,func){isMobile?(elem.css("touch-action","auto"),addEvent(elem[0],"touchstart",e=>{function mouseup(){removeEvent(document,"touchmove",mousemove,!0),removeEvent(document,"touchend",mouseup,!0)}function mousemove(e){func(elem,e.touches[0].clientX,e.touches[0].clientY),preventDefault(e)}func(elem,e.touches[0].clientX,e.touches[0].clientY),addEvent(document,"touchmove",mousemove,!0),addEvent(document,"touchend",mouseup,!0)})):addEvent(elem[0],"mousedown",e=>{function mouseup(){removeEvent(document,"mousemove",mousemove),removeEvent(document,"mouseup",mouseup)}function mousemove(e){func(elem,e.clientX,e.clientY),preventDefault(e)}func(elem,e.clientX,e.clientY),addEvent(document,"mousemove",mousemove),addEvent(document,"mouseup",mouseup)})}function setSlider(elem,x){let sliderRect=elem[0].getBoundingClientRect();percent=0,x-sliderRect.left<=sliderBorder+pointerRadius?($("#pointer").css("left","5px"),percent=0):x-sliderRect.left>=sliderWidth-pointerRadius-sliderBorder?($("#pointer").css("left",sliderWidth-2*pointerRadius-5+"px"),percent=1):($("#pointer").css("left",x-sliderRect.left-pointerRadius+"px"),percent=(x-sliderRect.left-pointerRadius-sliderBorder)/(sliderWidth-pointerRadius-2*sliderBorder)),curTool==Tools.Pen?penSize=(penPercent=percent)*pointerMaxSize>1?penPercent*pointerMaxSize:1:curTool==Tools.Eraser&&(eraserSize=(eraserPercent=percent)*pointerMaxSize>1?eraserPercent*pointerMaxSize:1)}function setSliderPointer(value){let x=0;x=value<=0?5:value>=1?sliderWidth-2*pointerRadius-5:value*(sliderWidth-pointerRadius-2*sliderBorder)+sliderBorder,$("#pointer").animate({left:x+"px"},200)}$(document).ready(()=>{initData(),initComponent(),loadAudio(),initCamera(),initRenderer(),initScene(),initLight(),rendererUpdate(),window.onresize=()=>{if(canvasRoot.css({width:document.body.clientWidth,height:document.body.clientHeight}),renderer.setSize(window.innerWidth,window.innerHeight),camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),guide){curScale=1;let minView=window.innerWidth<=window.innerHeight?window.innerWidth:window.innerHeight;guide.css({width:minView+"px",height:minView+"px",transform:"scale(1) translate(-50%,-50%)",left:.5*window.innerWidth+"px",top:.5*window.innerHeight+"px"})}}});